
## Extract parameters

```{r}
rm(list = ls())
library(rjags)
library(runjags)
library(lme4)
library(lmerTest)
source("../analysis_funcs.R")

WD = '../../data'
WDD = file.path(WD, 'experiment')
theme_set(theme_classic())

# Load previous fit
MYFILE = '../results/linear_drift_ddm-18-04-2022_20:50-10000-20000-jags-pars.RData'
load(MYFILE)
numSubjs = dataList$N

# Load data
load(file.path(WDD, "processed_data_censored.RData"))
grouping_var = 'subj_context'
choicedata.common$subj_context = paste(choicedata.common$subjID, choicedata.common$context)
dataList = organize_data(choicedata.common, grouping_var, long = T)
subjList <- unique(choicedata.common[c('subjID', 'context', 'context_num', 'context_order', 'background_col', grouping_var)]) 
```


```{r}
## Extract parameters
numPars <- 5

# Individual parameters (e.g., individual posterior means)
allIndPars <- array(NA, c(numSubjs, numPars))
allIndPars <- as.data.frame(allIndPars)

for (i in 1:numSubjs) {
  allIndPars[i, ] <- c( 
  mean(parVals$b.drift.intercept.p[i, ]), 
  mean(parVals$b.drift.amount.p[i, ]), 
  mean(parVals$bias.p[i, ]), 
  mean(parVals$nondectime.p[i, ]), 
  mean(parVals$noise.p[i, ])
  )
}

allIndPars = cbind(allIndPars, subjList[-ncol(subjList)]) 

colnames(allIndPars) <- c(
"b.drift.intercept.p", 
"b.drift.amount.p", 
"bias.p", 
"nondectime.p", 
"noise.p", 
"subjID", "context", "context_num", "context_order", "background_col")

# colors = c("red", "blue", "green")
# names(colors) = c("c1", "c2", "c3")
# allIndPars = allIndPars %>% mutate(factor = 0.5*(scale(b.drift.intercept.p) - scale(b.drift.amount.p)))
# pairs(allIndPars[1:numPars], col = colors[allIndPars$context] )
# cor(allIndPars[1:numPars])
```
## Remove subjects if they have low sensitivity

```{r}

Rhat = max(myfit_summary[, 'psrf'])
print(Rhat)

g = grep( "b.drift.amount.p\\[", rownames(myfit_summary))
allIndPars$lower_bound = myfit_summary[g, 'Lower95']
allIndPars$upper_bound = myfit_summary[g, 'Upper95']
allIndPars$Median = myfit_summary[g, 'Median']
allIndPars$b.drift.amount.p.0 = allIndPars$lower_bound >0 | allIndPars$upper_bound < 0 

plot(allIndPars$lower_bound[order(allIndPars$lower_bound)], type = 'l', ylim = c(min(allIndPars$lower_bound), max(allIndPars$upper_bound)),
     xlab = "Subject/Context", ylab = "5%-quantile for drift sensitivity")
#lines(allIndPars$upper_bound[order(allIndPars$lower_bound)]  , type = 'l')
abline(0, 0, col = 'red')

# NEX = 25                                                                                         
# examples = c(which(dataList$instance==3)[1:NEX], which(dataList$instance==5)[1:NEX], which(dataList$instance==7)[1:NEX], which(dataList$instance==9)[1:NEX])
# print(dataList$choice[examples] )
# plot(myfit, pars =  paste0("bias[", examples, "]"), collapse = T)
# plot(myfit, pars =  paste0("drift[", examples, "]"), collapse = T)
# plot(myfit, pars =  paste0("nondectime[", examples, "]"), collapse = T)
# 
# myplot = ggplot(allIndPars, aes(x = context, y = drift_intercept, group = subjID)) + geom_line()
# print(myplot)
# #myplot = ggplot(allIndPars, aes(x = subjID, y = drift)) + geom_violin() + theme(axis.text.x = element_text(angle = 45, hjust = 1))
# #print(myplot)
# #myplot = ggplot(allIndPars, aes(x = context, y = drift, group = subjID)) + geom_line() 
# #print(myplot)

```


```{r, fig.width = 15}
allIndPars$index = seq(nrow(allIndPars))

# keep subjects with a significant relationship between drift and value
allIndPars.subj = allIndPars %>% group_by(subjID) %>% summarise(keep = max(lower_bound) > 0) %>% filter(keep) %>% ungroup()
include_subjects = allIndPars.subj$subjID

allIndPars.sub = subset(allIndPars, subjID %in% include_subjects)

meandrift = colMeans(parVals$drift)
boxplot(meandrift ~ dataList$choice)
plot(meandrift ~ dataList$amount_later_centered)

```

## Group distributions for parameters

```{r}

for (var in c("context",  "background_col"))
{
  get_par_jags("b.drift.intercept.p", var)
  get_par_jags("b.drift.amount.p", var)
  get_par_jags("bias.p", var )
  get_par_jags("nondectime.p", var)
  get_par_jags("noise.p", var)
}
context_sigmas = c(5, 2, 1)

allIndPars$context_sigma = context_sigmas[allIndPars$context_num]

mypars = c("b.drift.intercept.p", "b.drift.amount.p", "bias.p", "nondectime.p", "noise.p") 


for (mypar in mypars){
  print("------------------------------------")
  print(mypar)
  myform = formula(paste(mypar, "context + context_order + (1|subjID)", sep = "~"))
  model = lmer(myform, data = allIndPars %>% filter(subjID %in% include_subjects))
  print(summary(model))

} 
```



## Plot RTs in relation to estimated subjective value
```{r}
breaks = seq(0.5, 8.5, 1)
choicedata = merge(choicedata.common, allIndPars %>% filter(subjID %in% include_subjects), by = c('subjID', 'context', 'context_order', 'background_col'))
choicedata = choicedata %>% mutate( ev = amount_later, context_num = as.numeric(substr(context, 2, 2))) %>% mutate(ev.cut = cut(ev, breaks))

# outliers removed beforehand
choicedata.group = choicedata %>% 
  group_by(subjID, context, ev.cut) %>% 
  dplyr::summarise(rt.median = median(rt), ev = mean(ev), prob_late = mean(choice))
choicedata.group = choicedata.group%>%
  group_by(context, ev.cut) %>% 
  dplyr::summarise(rt.mean = mean(rt.median), rt.sem = sem(rt.median), 
            prob_late.mean = mean(prob_late), prob_late.sem = sem(prob_late),
            ev = mean(ev))

myplot = ggplot(data = choicedata.group, aes(x = ev, y = rt.mean, ymin = rt.mean - rt.sem, ymax = rt.mean + rt.sem, color = context, group = context)) +
  geom_line() + 
  geom_point() + 
  geom_errorbar() + 
  xlab('Later amount') + 
  ylab('RT')

print(myplot)

myplot = ggplot(data = choicedata, aes(x = cut(ev, breaks), y = log(rt), fill = context)) +
  geom_violin() + 
  xlab('Subjective value of delayed reward') + 
  ylab('RT') + ylim(-5, 5)

#print(myplot)
#brm
model = lmer(log(rt) ~ context*amount_later_centered  + context_order + (1+ amount_later_centered|subjID), data = choicedata)
print(summary(model))
plot(model)

```



## Check probabilities

```{r}
myplot = ggplot(data = choicedata.group, aes(x = ev, y = prob_late.mean, ymin = prob_late.mean - prob_late.sem, 
                                             ymax = prob_late.mean + prob_late.sem, color = context, group = context)) +
  geom_line() + 
  geom_point() + 
  geom_errorbar() + 
  xlab('Later amount') + 
  ylab('Probability of late choice')

print(myplot)
model = glmer(choice ~ context*amount_later_centered  + context_order + (1 + amount_later_centered|subjID), data = choicedata, family = 'binomial' )
print(summary(model))
plot(model)
```






## Plot ratings in relation to estimated subjective value
```{r}
ratingdata.sub$bid.diff = ratingdata.sub$bid.high - ratingdata.sub$bid.low

ratingdata.sub$bid.rt.max = apply(ratingdata.sub[ c('bid.high.rt', 'bid.low.rt') ], 1, max)
ratingdata.sub$bid.rt.min = apply(ratingdata.sub[ c('bid.high.rt', 'bid.low.rt') ], 1, min)

ratingdata.sub = ratingdata.sub %>% 
  mutate(bid.rt.second = bid.rt.max - bid.rt.min,
         bid.rt.first = bid.rt.min)


#remove outliers
ratingdata.sub = ratingdata.sub %>% group_by(amount_later) %>% mutate(bid.diff.outlier = markoutliersIQR(log(bid.diff)),
                                                                      bid.rt.outlier = markoutliersIQR(log(bid.rt.max)))
ratingdata.sub.clean = subset(ratingdata.sub, bid.diff.outlier == F & bid.rt.outlier == F )


ratingdata = merge(ratingdata.sub.clean, allIndPars %>% filter(subjID %in% include_subjects), by = c('subjID', 'context', 'context_num', 'context_order', 'background_col'))
ratindata = subset(ratingdata, subjID %in% include_subjects)
ratingdata = ratingdata %>% mutate( ev = amount_later_centered, bid.diff = (bid.high - bid.low )) %>% mutate(ev2 = ev^2)

myplot = ggplot(data = ratingdata, aes(x = ev, y = bid.diff, color = context, group = subjID)) +
  geom_line() + 
  geom_point() + 
  xlab('Subjective value of delayed reward') + 
  ylab('Price range') + facet_grid(.~context)
print(myplot)

ratingdata.group = ratingdata %>% 
  group_by(context, amount_later) %>% 
  summarise(bid.diff.mean = mean(bid.diff), bid.diff.sem = sem(bid.diff), ev = mean(ev))

myplot = ggplot(data = ratingdata.group, aes(x = ev, y = bid.diff.mean, ymin = bid.diff.mean - bid.diff.sem, ymax = bid.diff.mean + bid.diff.sem, color = context)) +
  geom_line() + 
  geom_point() + 
  geom_errorbar() + 
  xlab('Subjective value of delayed reward') + 
#  ylab('Upper limit')
  ylab('Price range')

print(myplot)

model = lmer(bid.diff ~ context*amount_later_centered + context_order + (1 + amount_later_centered | subjID), 
             data = ratingdata )
print(summary(model))

model = lmer(bid.high ~ context*amount_later_centered + context_order + (1 + amount_later_centered | subjID), 
             data = ratingdata)
print(summary(model))

model = lmer(bid.low ~ context*amount_later_centered + context_order + (1 + amount_later_centered | subjID), 
             data = ratingdata)
print(summary(model))
```

## Rating RT
```{r}
mypars.rt = c('key.rt', 'bid.rt.max', 'bid.rt.min', 
           'bid.rt.second', 'bid.rt.first')

for (mypar in mypars.rt){
  print("------------------------------------")
  print(mypar)
  myform = formula(paste(paste0('log(', mypar, ')'), "context*amount_later_centered + context_order + (1 + amount_later_centered| subjID)", sep = "~"))
  model.rt = lmer(myform, data = ratingdata) 
  print(myform)
  print(summary(model.rt))
}

myplot = ggplot(data = ratingdata, aes(x = context, y = key.rt/1000, fill = context)) +
  geom_violin() + 
  xlab('Context') +
  ylab('RT') 
print(myplot)
```


## Check stability of parameters

```{r, fig.width = 15}

allIndPars.melt = melt(allIndPars %>% filter(subjID %in% include_subjects), id.vars = c("subjID", "context", "context_order"), variable.name = "parameter", value.name = "value") %>% filter(parameter %in% mypars) %>%mutate(value = as.numeric(value))
myplot = ggplot(allIndPars.melt, aes(x = context, y = value, group = subjID)) + geom_line() + facet_wrap( .~ parameter, scales = "free" )
print(myplot)
#myplot = ggplot(allIndPars.melt, aes(x = context, y = value, group = context )) + geom_violin() + facet_grid( context_order ~ parameter, scales = "free" )
#print(myplot)

allIndPars.melt$value.corr = 0
for ( mypar in mypars){
  mysubset = allIndPars.melt %>% filter(parameter == mypar)
  model = lmer(value ~ context + context_order + (1|subjID), data = mysubset )
  allIndPars.melt$value.corr[allIndPars.melt$parameter == mypar] =  predict(model,
                                                                            mysubset %>% 
                                                                            mutate(context_order = 0)) + resid(model)
  plot(value.corr ~ value, allIndPars.melt %>% filter(parameter == mypar) )
}


allIndPars.diff = merge(subset(allIndPars.melt, context == 'c1'), subset(allIndPars.melt, context == 'c2'), by = c('subjID', 'parameter'), suffixes = c('.c1', '.c2')) %>% mutate(value.corr = value.corr.c2 - value.corr.c1, c1_first = context_order.c1 == 1)
myplot = ggplot(allIndPars.diff, aes(x=0, y = value, fill = c1_first )) + geom_violin() + facet_wrap( . ~ parameter, scales = "free" )
#print(myplot)
myplot = ggplot(allIndPars.diff, aes(x=0, y = value)) + geom_violin() + geom_point(position = "jitter") + facet_wrap( . ~ parameter, scales = "free" )
#print(myplot)

allIndPars.sum <- summarySE(allIndPars.melt, measurevar="value.corr", groupvars=c("context","parameter"))

# Standard error of the mean
ggplot(allIndPars.sum, aes(x=context, y=value.corr)) + 
    geom_errorbar(aes(ymin = value.corr-se, ymax = value.corr+se), width=.1) +
    geom_line() +
    geom_point() + 
    facet_wrap(.~ parameter, scales = 'free')

allIndPars.sum <- summarySE(allIndPars.diff, measurevar="value.corr", groupvars=c( "parameter"))

# Standard error of the mean
ggplot(allIndPars.sum, aes(x=parameter, y=value.corr)) + 
    geom_errorbar(aes(ymin = value.corr-se, ymax = value.corr+se), width=.1) +
    geom_line() +
    geom_point() + 
    ylab('Parameter difference (low volatility - high volatility)') + 
    geom_hline(yintercept = 0, col = 'red')


```

## Check correlation between parameters

```{r, fig.width = 15}

options(width = 300)

xx = allIndPars %>% filter(subjID %in% include_subjects)
cor(xx[mypars])
pairs(xx[mypars])

xx = allIndPars %>% filter(subjID %in% include_subjects & nondectime.p < 2)
cor(xx[mypars])
pairs(xx[mypars])

```





















# Plot RTs in relation to estimated subjective value
```{r}
choicedata = merge(choicedata.sub, allIndPars, by = c('subjID', 'context', 'context_order', 'background_col'))
#choicedata = choicedata %>% mutate( ev = amount_later/(1 + k*delay_later), context_num = as.numeric(substr(context, 2, 2)))
choicedata = choicedata %>% mutate( ev = amount_later, context_num = as.numeric(substr(context, 2, 2)))
breaks = seq(0, 2.4, 0.4)
# remove outliers
choicedata.group = choicedata %>% 
  group_by(context, amount_later) %>% 
  summarise(rt.mean = median(rt), rt.sem = sem(rt), ev = mean(ev)) %>% mutate(ev.cut = cut(ev, breaks))

myplot = ggplot(data = choicedata.group, aes(x = ev.cut, y = rt.mean, ymin = rt.mean - rt.sem, ymax = rt.mean + rt.sem, color = context)) +
  geom_line() + 
  geom_point() + 
  geom_errorbar() + 
  xlab('Subjective value of delayed reward') + 
  ylab('RT')

#print(myplot)

myplot = ggplot(data = choicedata, aes(x = cut(ev, breaks), y = log(rt), fill = context)) +
  geom_violin() + 
  xlab('Subjective value of delayed reward') + 
  ylab('RT') + ylim(-5, 5)

#print(myplot)
#brm
model = lmer(log(rt) ~ context_order + context_num*ev + (1|subjID), data = choicedata)
#summary(model)
#plot(model)
```

# Plot ratings in relation to estimated subjective value
```{r}
ratingdata = merge(ratingdata.sub, allIndPars , by = c('subjID', 'context', 'context_num', 'context_order', 'background_col'))
#ratingdata = subset(ratingdata, subjID %in% include_subjects)
#ratingdata = ratingdata %>% mutate( drift = amount_later/(1 + k*delay_later), bid.diff = (bid.high - bid.low)) %>% mutate(drift2 = drift^2)
#  - 1) + b.drift.delay.p * (delay_later - 0)
ratingdata = ratingdata %>% mutate( drift = b.drift.intercept.p + b.drift.amount.p * amount_later, bid.diff = (bid.high - bid.low)) %>% mutate(drift2 = drift^2)
#ratingdata = ratingdata %>% mutate( ev = amount_later, bid.diff = (bid.high - bid.low)) %>% mutate(ev2 = ev^2)

myplot = ggplot(data = ratingdata, aes(x = amount_later, y = bid.diff, color = context, group = subjID)) +
  geom_line() + 
  geom_point() + 
#  xlab('Subjective value of delayed reward') + 
  xlab('Putative drift') + 
  ylab('Price range') + facet_grid(.~context)
print(myplot)

myplot = ggplot(data = ratingdata, aes(x = amount_later, y = drift, color = context, group = subjID)) +
  geom_line() + 
  geom_point() + 
#  xlab('Subjective value of delayed reward') + 
  xlab('Later amount') + 
  ylab('Putative drift') + facet_grid(.~context)
print(myplot)

myplot = ggplot(data = ratingdata, aes(x = drift, y = bid.diff, color = context, group = subjID)) +
  geom_line() + 
  geom_point() + 
#  xlab('Subjective value of delayed reward') + 
  xlab('Putative drift') + 
  ylab('Price range') + facet_grid(.~context)
print(myplot)

ratingdata.group = ratingdata %>% 
  group_by(context, amount_later) %>% 
  summarise(bid.diff.mean = mean(bid.diff), bid.diff.sem = sem(bid.diff), drift.mean = mean(drift), drift.sem = sem(drift))

myplot = ggplot(data = ratingdata.group, aes(x = amount_later, y = bid.diff.mean, ymin = bid.diff.mean - bid.diff.sem, ymax = bid.diff.mean + bid.diff.sem, color = context)) +
  geom_line() + 
  geom_point() + 
  geom_errorbar() + 
  xlab('Later amount') + 
  ylab('Price range')
print(myplot)

myplot = ggplot(data = ratingdata.group, aes(x = drift.mean, y = bid.diff.mean, ymin = bid.diff.mean - bid.diff.sem, ymax = bid.diff.mean + bid.diff.sem, color = context)) +
  geom_line() + 
  geom_point() + 
  geom_errorbar() + 
  xlab('Putative drift') + 
  ylab('Price range')
print(myplot)

myplot = ggplot(data = ratingdata.group, aes(x = amount_later, y = drift.mean, ymin = drift.mean - drift.sem, ymax = drift.mean + drift.sem, color = context)) +
  geom_line() + 
  geom_point() + 
  geom_errorbar() + 
  ylab('Drift') + 
  xlab('Later amount')
print(myplot)

model = lmer(bid.diff ~ drift + context+ context_order + (1 + drift|subjID), data = ratingdata)
summary(model)

model = lmer(drift ~ context+ context_order + (1 |subjID), data = ratingdata)
summary(model)

```


# Check stability of parameters

```{r, fig.width = 15}

allIndPars.melt = melt(allIndPars, id.vars = c("subjID", "context"), variable.name = "parameter", value.name = "value") %>% filter(parameter %in% mypars) %>%mutate(value = as.numeric(value))
myplot = ggplot(allIndPars.melt, aes(x = context, y = value, group = subjID)) + geom_line() + facet_wrap( .~ parameter, scales = "free" )
print(myplot)

```

# Check correlation between parameters

```{r, fig.width = 15}
options(width = 300)
cor(allIndPars[mypars])
pairs(allIndPars[mypars])

```

