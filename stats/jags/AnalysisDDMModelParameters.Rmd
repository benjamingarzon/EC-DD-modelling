
# Perform analyses on response variables and parameters
```{r}
rm(list = ls())
source("../analysis_funcs.R")

statslist = list()

WD = '../../data'
WDD = file.path(WD, 'experiment')
mytheme = theme_classic(base_size = 13) + theme(legend.position = 'bottom', legend.title = element_blank())
theme_set(mytheme)
# Load previous fit
MYFILE = '../results/linear_drift_ddm-02-05-2022_00:03-10000-50000-jags-pars.RData'
load(MYFILE)
numSubjs = dataList$N

# Load data
load(file.path(WDD, "processed_data_censored.RData"))
grouping_var = 'subj_context'
choicedata.common$subj_context = paste(choicedata.common$subjID, choicedata.common$context)
dataList = organize_data(choicedata.common, grouping_var, long = T)
subjList <-
  unique(choicedata.common[c('subjID',
                             'context',
                             'context_num',
                             'context_order',
                             'background_col',
                             grouping_var)])

choicedata.common = choicedata.common %>% mutate(
  Context = ifelse(context == 'c1', 'High volatility', 'Low volatility'),
  Choice = ifelse(choice == 1, 'Later option', 'Immediate option'),
  Context_order = ifelse(context_order == 1, 'First context', 'Second context'),
  Group =  ifelse(
    context_order == 1 &
      context == 'c1' |
      context_order == 2 & context == 'c2' ,
    'High first',
    'Low first'
  )
)

ratingdata.sub = ratingdata.sub %>% mutate(
  Context = ifelse(context == 'c1', 'High volatility', 'Low volatility'),
  Context_order = ifelse(context_order == 1, 'First context', 'Second context'),
  Group =  ifelse(
    context_order == 1 &
      context == 'c1' |
      context_order == 2 & context == 'c2' ,
    'High first',
    'Low first'
  )
)
```

# Extract parameters
```{r}
numPars <- 5

# Individual parameters (e.g., individual posterior means)
allIndPars <- array(NA, c(numSubjs, numPars))
allIndPars <- as.data.frame(allIndPars)

for (i in 1:numSubjs) {
  allIndPars[i, ] <- c(
    mean(parVals$b.drift.intercept.p[i, ]),
    mean(parVals$b.drift.amount.p[i, ]),
    mean(parVals$bias.p[i, ]),
    mean(parVals$nondectime.p[i, ]),
    mean(parVals$noise.p[i, ])
  )
}

allIndPars = cbind(allIndPars, subjList[-ncol(subjList)])

colnames(allIndPars) <- c(
  "b.drift.intercept.p",
  "b.drift.amount.p",
  "bias.p",
  "nondectime.p",
  "noise.p",
  "subjID",
  "context",
  "context_num",
  "context_order",
  "background_col"
)

allIndPars = allIndPars %>% mutate(
  Context = ifelse(context == 'c1', 'High volatility', 'Low volatility'),
  Context_short = ifelse(context == 'c1', 'High', 'Low'),
  Context_order = ifelse(context_order == 1, 'First context', 'Second context'),
  Group =  ifelse(
    context_order == 1 &
      context == 'c1' |
      context_order == 2 & context == 'c2' ,
    'High first',
    'Low first'
  )
)
```

# Remove subjects if they have low sensitivity
```{r}
Rhat = max(myfit_summary[, 'psrf'])
print(Rhat)

g = grep("b.drift.amount.p\\[", rownames(myfit_summary))
allIndPars$lower_bound = myfit_summary[g, 'Lower95']
allIndPars$upper_bound = myfit_summary[g, 'Upper95']
allIndPars$Median = myfit_summary[g, 'Median']
allIndPars$b.drift.amount.p.0 = allIndPars$lower_bound > 0 |
  allIndPars$upper_bound < 0

plot(
  allIndPars$lower_bound[order(allIndPars$lower_bound)],
  type = 'l',
  ylim = c(min(allIndPars$lower_bound), max(allIndPars$upper_bound)),
  xlab = "Subject/Context",
  ylab = "5%-quantile for drift sensitivity"
)
#lines(allIndPars$upper_bound[order(allIndPars$lower_bound)]  , type = 'l')
abline(0, 0, col = 'red')
```

# Keep only subjects with a significant relationship between drift and value
```{r, fig.width = 15}
allIndPars$index = seq(nrow(allIndPars))

allIndPars.subj = allIndPars %>% group_by(subjID) %>% summarise(keep = max(lower_bound) > 0) %>% filter(keep) %>% ungroup()
include_subjects = allIndPars.subj$subjID

allIndPars.sub = subset(allIndPars, subjID %in% include_subjects)
```

# Remove outliers
```{r}
#allIndPars = allIndPars %>% filter(nondectime.p < 2)
```



## Group distributions for parameters
```{r}
for (var in c("context",  "background_col", "context_order"))
{
  get_par_jags("b.drift.intercept.p", var)
  get_par_jags("b.drift.amount.p", var)
  get_par_jags("bias.p", var)
  get_par_jags("nondectime.p", var)
  get_par_jags("noise.p", var)
}

get_par_jags("b.drift.intercept.p", var2 = "Context", var = "context_order")
get_par_jags("b.drift.amount.p", var2 = "Context", var = "context_order")
get_par_jags("bias.p", var2 = "Context", var = "context_order")
get_par_jags("nondectime.p", var2 = "Context", var = "context_order")
get_par_jags("noise.p", var2 = "Context", var = "context_order")

context_sigmas = c(5, 2, 1)

allIndPars$context_sigma = context_sigmas[allIndPars$context_num]

mypars = c("b.drift.intercept.p",
           "b.drift.amount.p",
           "bias.p",
           "nondectime.p",
           "noise.p")

for (mypar in mypars) {
  print("------------------------------------")
  print(mypar)
  myform = formula(paste(
    mypar,
    "context + context_order + background_col + (1|subjID)",
    sep = "~"
  ))
  model = lmer(myform, data = allIndPars %>% filter(subjID %in% include_subjects))
  print(summary(model))
} 
```


## Plot RTs in relation to estimated subjective value
```{r}
source('./RTanalysis.R')
```

## Check distribution of context order and Context
```{r}
choicedata.order = choicedata %>% group_by(subjID) %>% slice_head(n=1) 
choicedata.order = choicedata.order %>% group_by(Context, context, context_order) %>% summarise(size = n())
print(choicedata.order)
```

## Check probabilities

```{r}
myplot.choiceprob = ggplot(
  data = choicedata.group,
  aes(
    x = ev,
    y = prob_late.mean,
    ymin = prob_late.mean - prob_late.sem,
    ymax = prob_late.mean + prob_late.sem,
    color = Context
  )
) +
  geom_line() +
  geom_point() +
  geom_errorbar(width = 0.5) +
  xlab('Later amount ($)') +
  ylab('Frequency of later option') + theme(legend.position = 'bottom', legend.title = element_blank()) + facet_grid(. ~ Group)

print(myplot.choiceprob)

model = fitmodel(
  "choice ~ Group*Context*amount_later_centered + (1|subjID)",
  choicedata,
  c(
    "_choice_context_" = "ContextLow volatility",
    "_choice_groupxcontext_" = "GroupLow first:ContextLow volatility",
    "_choice_groupxamount_" = "GroupLow first:amount_later_centered",
    "_choice_contextxamount_" = "ContextLow volatility:amount_later_centered"
  ),
  family = 'binomial'
)
print(summary(model))
```


## Plot ratings in relation to estimated subjective value
```{r}
source('./RatingAnalysis.R')
```

## Rating RT
```{r}
# remove outliers?
source("./RatingRTanalysis.R")

```

## Random slopes of ratings vs DDM parameters

```{r}
main.mat = inter.mat = NULL

mypars.rating = c("bid.diff") #bid.high", "bid.low")
for (mypar.rating in mypars.rating){
for (mypar in mypars){
     myformula = as.formula(sprintf("%s ~ scale(%s)*Group*Context*amount_later_centered + (1| subjID)", mypar.rating, mypar)) 
     model = lmer(myformula, data = ratingdata)
     ss = summary(model)
     print(myformula)
    # print(ss)
     ss.1 = coef(ss)[9, c("t value", "Pr(>|t|)")]
     ss.2 = coef(ss)[9, c("t value", "Pr(>|t|)")]
     main.mat = rbind(main.mat, c(mypar.rating, mypar, round(ss.1, 3)))
     inter.mat = rbind(inter.mat, c(mypar.rating, mypar, round(ss.2, 3)))
     
  } 
} 
main.mat = as.data.frame(main.mat)
inter.mat = as.data.frame(inter.mat)
colnames(main.mat) = colnames(main.mat) = c("rating_par", "choice_par", "t", "p")
View(main.mat)
View(inter.mat)


myplot.main.intercept = ggplot(ratingdata, aes(x = jitter(amount_later), y = b.drift.intercept.p, col = bid.diff )) + geom_point() + scale_color_viridis_c()
print(myplot.main.intercept)

myplot.main.amount = ggplot(ratingdata, aes(x = jitter(amount_later), y = b.drift.amount.p, col = bid.diff )) + geom_point() + scale_color_viridis_c()
print(myplot.main.amount)

```

## Check stability of parameters

```{r, fig.width = 15}

allIndPars.melt = melt(allIndPars %>% filter(subjID %in% include_subjects), id.vars = c("subjID", "Context", "context", "context_order", "Group"), variable.name = "parameter", value.name = "value") %>% filter(parameter %in% mypars) %>%mutate(value = as.numeric(value), parameter_label = par_labels[parameter])
myplot.reliab = ggplot(allIndPars.melt, aes(x = Context, y = value, group = subjID)) + geom_line(size = 0.4) + geom_point(size = 0.6) +
  ylab('Parameter value') + 
  xlab('Volatility') + 
  facet_wrap( .~ parameter_label, scales = "free", nrow = 1 )

print(myplot.reliab)
#myplot = ggplot(allIndPars.melt, aes(x = context, y = value, group = context )) + geom_violin() + facet_grid( context_order ~ parameter, scales = "free" )
#print(myplot)

allIndPars.melt$value.corr = 0
for ( mypar in mypars){
  mysubset = allIndPars.melt %>% filter(parameter == mypar)
  model = lmer(value ~ context + context_order + (1|subjID), data = mysubset )
  allIndPars.melt$value.corr[allIndPars.melt$parameter == mypar] =  predict(model,
                                                                            mysubset %>% 
                                                                            mutate(context_order = 0)) + resid(model)
  plot(value.corr ~ value, allIndPars.melt %>% filter(parameter == mypar) )
}
```
# Parameter tests

```{r, fig.width = 15}
allIndPars.diff = merge(subset(allIndPars.melt, context == 'c1'), subset(allIndPars.melt, context == 'c2'), by = c('subjID', 'parameter'), suffixes = c('.c1', '.c2')) %>% mutate(value.corr = value.corr.c2 - value.corr.c1, c1_first = context_order.c1 == 1)

myplot = ggplot(allIndPars.diff, aes(x=0, y = value.corr, fill = c1_first )) + geom_violin() + facet_wrap( . ~ parameter, scales = "free" )
print(myplot)

myplot = ggplot(allIndPars.diff, aes(x=0, y = value.corr)) + geom_violin() + geom_point(position = "jitter") + facet_wrap( . ~ parameter, scales = "free" )
print(myplot)

allIndPars.sum <- summarySE(allIndPars.melt, measurevar="value.corr", groupvars=c("Context", "context", "parameter_label", "context_order", "Group"))

# Standard error of the mean

myplot.differences = ggplot(allIndPars.sum, aes(x = Context, y=value.corr, ymin = value.corr-se, ymax = value.corr+se, col = Group, group = Group)) + 
    geom_point(position = position_dodge(0.5)) + 
    geom_errorbar(position = position_dodge(0.5)) +
    geom_line(position = position_dodge(0.5)) + 
    ylab('Parameter value') + 
    xlab('Context order')  +
    facet_wrap(.~ parameter_label, scales = 'free', nrow = 1)
#    ggh4x::facet_grid2(context_order ~ parameter_label, scales = 'free_y', independent = 'y')

print(myplot.differences)

myplot.differences.all = ggplot() + 
    geom_line(data = allIndPars.melt, aes(x = context_order, y = value, group = subjID, col = Context), size = 0.2, alpha = 0.4) + 
    geom_point(data = allIndPars.melt, aes(x = context_order, y = value, group = subjID, col = Context), size = 0.5, alpha = 0.4) +
    geom_line(data = allIndPars.sum, aes(col=Context, y=value.corr, x = Group), size = 1) + 
    geom_point(data = allIndPars.sum, aes(col=Context, y=value.corr, x = Group), size = 1) + 
    geom_errorbar(data = allIndPars.sum, aes(ymin = value.corr-se, ymax = value.corr+se, col=Context, y=value.corr, x = Group), width=0.2, size = 1) +
    ylab('Parameter value') + 
    xlab('') + 
    facet_wrap(.~ parameter_label, scales = 'free', nrow = 1)
#print(myplot.differences.all)

allIndPars.sum <- summarySE(allIndPars.diff, measurevar="value.corr", groupvars=c( "parameter"))
```
```{r}

allIndPars.good = allIndPars %>% filter(subjID %in% include_subjects)
parameters = c("nondectime.p",
               "b.drift.intercept.p",
               "b.drift.amount.p",
               "noise.p",
               "bias.p")

tests = c("ContextLow volatility",
          "GroupLow first:ContextLow volatility")
for (parameter in parameters) {
  names(tests) = c(sprintf("_%s_context_", parameter),
                   sprintf("_%s_groupxcontext_", parameter))
  model = fitmodel(
    sprintf("%s ~ Group * Context + (1|subjID)", parameter),
    allIndPars %>% filter(subjID %in% include_subjects),
    tests
  )
}
print(summary(model))

```


```{r, fig.width = 15}
# Standard error of the mean
myplot = ggplot(allIndPars.sum, aes(x=parameter, y=value.corr)) + 
    geom_errorbar(aes(ymin = value.corr-se, ymax = value.corr+se), width=.1) +
    geom_line() +
    geom_point() + 
    ylab('Parameter difference (low volatility - high volatility)') + 
    geom_hline(yintercept = 0, col = 'red')
print(myplot)

```

## Check correlation between parameters

```{r, fig.width = 15}


options(width = 300)


mydata = allIndPars %>% filter(subjID %in% include_subjects & nondectime.p <2)
cor(mydata[mypars])
pairs(mydata[mypars])


myplot.pairs <- ggpairs(mydata, columns = mypars, ggplot2::aes(colour=Context), columnLabels = par_labels)
print(myplot.pairs)
```



```{r}

HEIGHT1ROW = 4.06
WIDTH1COL = 3.8 
DPI = 600

FIGS_DIR = '../figs'

fig.a1 = ggarrange(myplot.RT.choice, myplot.choiceprob, ncol=2, nrow=1, labels = c('A', 'B'))
fig.a2 = ggarrange(myplot.differences, ncol=1, nrow=1, labels = c('C'))
fig.a = ggarrange(fig.a1, fig.a2, ncol=1, nrow=2, heights = c(1, 1))
ggsave(filename=file.path(FIGS_DIR, "Choices.png"), plot = fig.a, dpi = DPI, width = WIDTH1COL*3, height = HEIGHT1ROW*2)


fig.b = ggarrange(myplot.range, myplot.key.rt, ncol=2, nrow=1, labels = c('A', 'B'))
ggsave(filename=file.path(FIGS_DIR, "Ratings.png"), plot = fig.b, dpi = DPI, width = WIDTH1COL*2, height = HEIGHT1ROW)


#ggsave(filename=file.path(FIGS_DIR, "Correlations.png"), plot = myplot.pairs, dpi = DPI, width = WIDTH1COL*2, height = HEIGHT1ROW*2)

print(fig.a)
print(fig.b)
#print(fig.c)

```



```{r}
filein = '../results/results_text.txt'
fileout = '../results/results_text_fixed.txt'
text = readLines(filein)
print(statslist)
text.new = NULL
placeholders = names(statslist)
for (line in text){ 
for (placeholder in placeholders){
  line = gsub(placeholder, replacement = statslist[placeholder], line)
}
text.new = c(text.new, line)

}
unlink(fileout)
writeLines(text.new, con = fileout, )
```

